<html>
<head>
    <script type="text/javascript"
            src="https://www.airconsole.com/api/airconsole-latest.js"></script>
    <script type="text/javascript" 
            src="//ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script type="text/javascript"
            src="airconsole-view-manager.js"></script>
    
	<link rel="stylesheet" type="text/css" href="controllerStyle.css">
</head>

<body onload="setup()">
	<!--START GAME SCREEN-->
    <div id="start" class="view">
        <div id="next_combat_button" class="startbutton">
            Start game!
        </div>
    </div>

    <!--PLANNING SCREEN-->  
	<div id="planning" class="view">
        <div id="map_switch" class="button map_button">
			<span id="map_current" class="map_text">0 </span>
			<span id="map_max" class="map_text">/ 9</span>
		</div>
		
		<div id="planned_actions_area" class="planning_area" style="left: 20%">
			<div id="planned_action_1" class="button action_button" onclick="plannedActionButton(0)"  style="left: 13%">
				1
			</div>
			<div id="planned_action_2" class="button action_button" onclick="plannedActionButton(1)" style="left: 69%">
				2
			</div>
        </div>
        <div id="action_button_area" class="planning_area" style="top: 31%">
          
            <div id="move_down_button" class="button action_button" onclick="setAction(3, action_selector)" style="left: 34%">
                
            </div>
            <div id="move_up_button" class="button action_button" onclick="setAction(2, action_selector)" style="left: 2%">
               
            </div>
            <div id="move_left_button" class="button action_button" onclick="setAction(0, action_selector)" style="left: 2%">
               
            </div>
            <div id="move_right_button" class="button action_button" onclick="setAction(1, action_selector)" style="left: 34%">
                
            </div>
            <div id="interact_button" class="button action_button" onclick="setAction(4, action_selector)" style="left: 74%">
                
            </div>
        </div>
        <div id="execute_turn_button_area" class="planning_area">
            <div id="execute_turn_button" class="button" onclick="executeTurn()" style="left: 10%">
            </div>
        </div>

    </div>
   
    <!--WAITING FOR TURN SCREEN-->
	<div id="waiting" class="view default-view">
        <div id="waiting_map_switch" class="button map_button">
			<div class="map_amount">
				<span id="map_current_wait" class="map_text">0</span>
				<span id="map_max_wait" class="map_text">/ 9</span>
			</div>
		</div>
		<div id="planned_actions_area_wait" class="planning_area" style="left: 20%">
			<div id="planned_action_1_wait" class="button action_button" style="left: 13%">
				1
			</div>
			<div id="planned_action_2_wait" class="button action_button" style="left: 69%">
				2
			</div>
			
        </div>
        <div id="action_button_area_wait" class="planning_area" style="top: 31%">
          
            <div id="move_down_button_wait" class="button action_button" style="left: 34%">
               
            </div>
            <div id="move_up_button_wait" class="button action_button" style="left: 2%">
              
            </div>
            <div id="move_left_button_wait" class="button action_button" style="left: 2%">
                
            </div>
            <div id="move_right_button_wait" class="button action_button" style="left: 34%">
                
            </div>
            
            <!-- <div id="dig_button_wait" class="button action_button" style="left: 74%"> -->
               
            <!-- </div> -->
            <div id="interact_button_wait" class="button action_button" style="left: 74%">
                
            </div>
        </div>
        <div id="execute_turn_button_area_wait" class="planning_area">
            <div id="execute_turn_button_wait" class="button" style="left: 10%">
                
            </div>
			
        </div>
		<div id="waiting_image">
				 WAITING 
			</div>
        
    </div>
	
	<!-- MAP SCREEN -->
	<div id="map_screen" class="view" >
		<div id="map_return" class="button map_button">
			
		</div>
		<div class="map_area">
			<div id="map_1" class="map_piece" style="left: 21%">
				
			</div>
			<div id="no_map_1" class="map_piece" style="left: 21%">
				MAP PIECE TOP LEFT
			</div>
			<div id="map_2" class="map_piece"	style="left: 40%">
				
			</div>
			<div id="no_map_2" class="map_piece"	style="left: 40%">
				MAP PIECE TOP MIDDLE
			</div>
			<div id="map_3" class="map_piece" style="left: 59%">
				
			</div>
			<div id="no_map_3" class="map_piece" style="left: 59%">
				MAP PIECE TOP RIGHT
			</div>
			<div id="map_4" class="map_piece"	style="left: 21%">
				
			</div>
			<div id="no_map_4" class="map_piece"	style="left: 21%">
				MAP PIECE MIDDLE LEFT
			</div>
			<div id="map_5" class="map_piece"	style="left: 40%">
			
			</div>
			<div id="no_map_5" class="map_piece"	style="left: 40%">
				MAP PIECE MIDDLE
			</div>
			<div id="map_6" class="map_piece"	style="left: 59%">
				
			</div>
			<div id="no_map_6" class="map_piece"	style="left: 59%">
				MAP PIECE MIDDLE RIGHT
			</div>
			<div id="map_7" class="map_piece"	style="left: 21%">
			</div>
			<div id="no_map_7" class="map_piece"	style="left: 21%">
				MAP PIECE BOTTOM LEFT
			</div>
			<div id="map_8" class="map_piece"	style="left: 40%">
				
			</div>
			<div id="no_map_8" class="map_piece"	style="left: 40%">
				MAP PIECE BOTTOM MIDDLE
			</div>
			<div id="map_9" class="map_piece" style="left: 59%">
				
			</div>
			<div id="no_map_9" class="map_piece" style="left: 59%">
				MAP PIECE BOTTOM RIGHT
			</div>
		</div>
	</div>
    <!--COMBAT SCREEN-->
    <div id="combat_splash" class="view"> READY STEADY GO </div>
    <div id="combat" class="view">

        <div id="start_combat">
            <div id="1" class="b" onclick="press(this.id)">1</div>
            <div id="2" class="b" onclick="press(this.id)">2</div>
            <div id="3" class="b" onclick="press(this.id)">3</div>
        </div>
    </div>
    <!--COMBAT RESULT SCREENS-->
    <div id="combat_result_won" class="view">YOU WON</div>
    <div id="combat_result_lost" class="view">YOU LOST</div>
    
    <script type="text/javascript">

        //airconsole stuff
        var airconsole;
        var vm;

        var possible_actions = ["left_down", "right_down", "left_up", "right_up", "interact"];

        //for handling actions
        var actions = [];
        var action_selector = 0;
        var planned_action_buttons = [document.getElementById("planned_action_1"), document.getElementById("planned_action_2")];

        //for handling map
        var map_element = document.getElementById("map_current");
        var map_element_wait = document.getElementById("map_current_wait");
        var whole_map = "000000000";
        var total_map_pieces = 0;

        /*COMBAT BUTTONS*/
        //determines the number of buttons present
        var num_buttons = 3;

        //the button with this value should be clicked first
        var next_combat_button = 1;

        //number of combat_button_parameters for position (left_start, left_end, top_start, top_end)
        var combat_button_param = 4;
        /****/

        function setup() {

            //initialise airconsole
            airconsole = new AirConsole({ "orientation": "landscape" });

            airconsole.onReady = function () {
                vm = new AirConsoleViewManager(airconsole);
                sendMessage(AirConsole.SCREEN, "test_message", "test_name_1", "test_param_1");
            }

            //messages received from screen
            airconsole.onMessage = function (device_id, data) {
                if (device_id == AirConsole.SCREEN)
                {
                    switch(data.action)
                    {
                        case 'turn':
                            //your turn
                            vm.show('planning');
                            break;
                        case 'attack':
                            //initiate combat
                            console.log("attack message received");

                            //place random buttons
                            randomPosition("3", 0);
                            randomPosition("2", 1);
                            randomPosition("1", 2);
                            //splash screen for combat
                            vm.show('combat_splash')

                            //show combat screen
                            setTimeout(function () {
                                vm.show('combat');;
                            }, 2500);
                            break;
                        case 'combat_result_won':
                            //you won combat
                            //show victory screen
                            vm.show('combat_result_won');

                            //compare your map to other player's map, and retrieve a map piece of theirs,
                            //that you don't have
                            getOtherMapPiece(data.map);

                            //respond to screen
                            setTimeout(function () {
                                vm.show('waiting');
                                sendMessage(AirConsole.SCREEN, 'combat_result_acknowledged');
                            }, 2500);
                            break;
                        case 'combat_result_loss':
                            //show loss screen
                            vm.show('combat_result_lost');

                            //send map to screen
                            sendMessage(AirConsole.SCREEN, "map_piece_loss", "map", whole_map);
                            setTimeout(function () {
                                vm.show('waiting');
                            }, 2500);
                            break;
                        case 'map_piece_found':
                            //acquire map piece from arena
                            var map_piece = data['map_piece'];
                            console.log('map_piece: ' + map_piece);

                            //place map piece in the correct position of the string
                            whole_map = whole_map.replaceAt(map_piece, '1');
                            console.log('whole_map: ' + whole_map);
                            //increases the number of map pieces on the screen
                            increaceCurrentMapPiece();
                            break;
                        case 'player_color':
                            document.body.style.backgroundImage = "url('/img/backgroundtexture_" + data.color + ".png')";
                            
                    }
                }
            }

            
        };   

        function increaceCurrentMapPiece() {
            total_map_pieces++;
            var value = GetElementInsideContainer("waiting", "map_current_wait");
            value.textContent = total_map_pieces.toString();
            var current_value = GetElementInsideContainer("map_switch", "map_current");
            current_value.textContent = total_map_pieces.toString();
        }

        //when player clicks plannedAction button
        function plannedActionButton(selector) {
            console.log("plannedactionbutton" + selector);
            action_selector = selector;
        }

        function setAction(action, action_selector)
		{
		    console.log("Action: " + possible_actions[action] + " Set image to /img/" + possible_actions[action_selector] + ".png");
			actions[action_selector] = possible_actions[action];
			planned_action_buttons[action_selector].style.backgroundImage = "url('/img/" + possible_actions[action] + ".png')";

			if (actions[0] != null && actions[1] == null)
			{
			    action_selector = 1;
			    plannedActionButton(action_selector);
			}
		};

        function executeTurn() {

            //send turn actions to screen
            sendMessage(AirConsole.SCREEN, 'turn_action', 'action_1', actions[0], 'action_2', actions[1]);

            your_turn = false;
            vm.show('waiting');
        }

        //create 2D array to store previous "button" positions in
        var combat_button_param_arr = new Array(num_buttons);
        for (var i = 0; i < num_buttons; i++) {
            combat_button_param_arr[i] = new Array(combat_button_param);
        }

        function randomPosition(id, index) {
            //all combat buttons are inside div with id "start_combat"
            var d = GetElementInsideContainer("start_combat", id);
            assignRandom(d, index);
        }

        //assings random position to a button
        function assignRandom(d, index) {
            //for making sure the button doesn't go out of bounds
            var button_width = (d.offsetWidth / window.innerWidth) * 100;
            var button_height = (d.offsetHeight / window.innerHeight) * 100;

            //random position
            var left = getRandomArbitrary(10, 100 - button_width);
            var top = getRandomArbitrary(10, 100 - button_height);

            var imgnum = index + 1;

            d.style.left = left + '%';
            d.style.top = top + '%';

            d.style.backgroundImage = "url('/img/attackbutton_" + imgnum + ".png')";

            if (!checkBoundaries(combat_button_param_arr, left, left + button_width, top, top + button_height)) {
                assignRandom(d, index);
            }
            else {
                combat_button_param_arr[index] = [left, left + button_width, top, top + button_height];
            }
        }

        //checks if the "button" overlaps existing "button"
        function checkBoundaries(arr, fromWidth, toWidth, fromHeight, toHeight) {
            for (var i = 0; i < arr.length; i++) {
                //a beatiful if statement ^^
                if (((arr[i][0] >= fromWidth && arr[i][0] <= toWidth) ||
                    (arr[i][1] >= fromWidth && arr[i][1] <= toWidth)) &&
                    ((arr[i][2] >= fromHeight && arr[i][2] <= toHeight) ||
                    (arr[i][3] >= fromHeight && arr[i][3] <= toHeight))) {
                    return false;
                }
            }
            return true;
        }

        //executes when the "button" is pressed
        function press(clicked_id) {
            eraseButton(clicked_id);
            //checks if "buttons" are pressed in correct order
            if (clicked_id == next_combat_button) {
                if (num_buttons == next_combat_button) {
                    sendMessage(AirConsole.SCREEN, "attack_response_success");
                }

                next_combat_button++;
            }
            else {
                sendMessage(AirConsole.SCREEN, "attack_response_failure", "map", whole_map);
                vm.show('combat_result_lost');
                setTimeout(function () {
                    vm.show('waiting');
                }, 2500);
            }
        }

        function eraseButton(id) {
            var d = GetElementInsideContainer("start_combat", id);
            d.style.display = "none";
        }

        //checks other player map pieces and "steals" one of them
        function getOtherMapPiece(mapPieces) {
            
            //go through other player map pieces
            for (var i = 0; i < mapPieces.length; i++) {
                //if other player has a map piece this player does not have, then steal it
                if (mapPieces[i] == '1' && whole_map[i] == '0') {
                    whole_map = whole_map.replaceAt(i, '1');
                    console.log('map piece inserted at ' + i);
                    console.log('new map: ' + whole_map);
                    break;
                }
            }
        }
		

        //send generic messages to screen
		function sendMessage(device, action, param_1_name, param_1, param_2_name, param_2)
		{
		    var message = {
		        'action': action
		    };
            //arguments.length = number of arguments in method call
		    switch (arguments.length) {
		        case 4:
		            message = message_param_1(message, param_1_name, param_1);
		            break;
		        case 6:
		            message = message_param_2(message, param_1_name, param_1, param_2_name, param_2);
		            break;
		    }
		    console.log("Sending message to " + AirConsole.SCREEN + " with action " + message.action);
		    airconsole.message(device, message);
		}

        //message with one custom parameter
		function message_param_1(message, param_1_name, param_1)
		{
		    message[param_1_name] = param_1;
		    console.log("message has custom parameter " + message[param_1_name]);
		    return message;
		}
        
        //message with two custom parameters
		function message_param_2(message, param_1_name, param_1, param_2_name, param_2)
		{
		    message[param_1_name] = param_1;
		    message[param_2_name] = param_2;

		    console.log("message has custom parameters " + message[param_1_name] + " and " + message[param_2_name]);
		    return message;
		}

		// Returns a random number between min (inclusive) and max (exclusive)
		function getRandomArbitrary(min, max) {
		    return Math.random() * (max - min) + min;
		}

		//get the div inside a div
		function GetElementInsideContainer(containerID, childID) {
		    var elm = {};
		    var elms = document.getElementById(containerID).getElementsByTagName("*");
		    for (var i = 0; i < elms.length; i++) {
		        if (elms[i].id === childID) {
		            elm = elms[i];
		            break;
		        }
		    }
		    return elm;
		}

        //for replacing a single character in a string
		String.prototype.replaceAt = function (index, character) {
		    return this.substr(0, index) + character + this.substr(index + character.length);
		}
    </script>

</body>

</html>